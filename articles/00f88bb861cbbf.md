---
title: "ã€ãƒ¡ãƒ¢ã€‘å€‹äººé–‹ç™ºæ‰‹é †ãƒ¡ãƒ¢"
emoji: "ğŸ—‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["go", "Echo", "GORM", "Clean Architecture", "React", "tailwindcss"]
published: false
---

## æ¦‚è¦

- Docker/ã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒ
  - backend
    - ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰
    - ãƒ‡ãƒãƒƒã‚°
  - frontend
- backend
  - Go
  - Echo
  - CleanArchitecture
  - (GORM)
- frontend
  - React
  - tailwindcss
- å®Ÿè£…
  - ãƒ­ã‚°ã‚¤ãƒ³

ç¾çŠ¶ä¸Šè¨˜ã®è¦ä»¶ã«åˆè‡´ã™ã‚‹é–‹ç™ºç’°å¢ƒã®æ§‹ç¯‰æ‰‹é †ãƒ¡ãƒ¢ã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ»ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ã‚‚ã«ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã¾ã§é–‹ç™ºã™ã‚‹ã€‚

### å‚è€ƒæ•™æ

Golang ã§ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åŸºç¤ã‚’å­¦ã‚“ã ä»¥ä¸‹ã®æ•™æã‚’å‚è€ƒã«ã—ã¦ã¾ã™ï¼ï¼ˆã‚ã¡ã‚ƒã‚ã‹ã‚Šã‚„ã™ã„ã®ã§ãŠã™ã™ã‚ï¼‰
[Udemy - ã€ŒEcho/Go + React ã§å§‹ã‚ã‚‹ãƒ¢ãƒ€ãƒ³ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã€](https://www.udemy.com/course/echo-go-react-restapi/)

## ç’°å¢ƒæ§‹ç¯‰æ‰‹é †

### ãƒ™ãƒ¼ã‚¹ã®ä½œæˆ

- ã¾ãšã€ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã™ã‚‹ã€‚

```sh
mkdir hoge-app
```

- docker-compose ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

```sh
touch docker-compose.yml
```

- docker-compose.yml

```yml
version: "3.8"

services:
  app:
    build: ./trello-clone
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
    volumes:
      - ./trello-clone:/app
  db:
    container_name: trello-clone-db
    image: postgres:15.1-alpine
    ports:
      - 5434:5432
    environment:
      POSTGRES_USER: db-dev-user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: dev-db
    volumes:
      - db-data:/var/lib/postgresql/data
    restart: always
  api:
    container_name: trello-clone-api
    build: ./trello-clone-api
    ports:
      - "8080:8080"
      - "2345:2345" #delvï¼ˆãƒ‡ãƒãƒƒã‚°ï¼‰ç”¨ã®ãƒãƒ¼ãƒˆ
    environment:
      GO_ENV: dev
      PORT: 8080
      POSTGRES_USER: db-dev-user
      POSTGRES_PW: password
      POSTGRES_DB: dev-db
      POSTGRES_PORT: 5432
      POSTGRES_HOST: db # Dockerã§apièµ·å‹•æ™‚
      #POSTGRES_HOST=localhost # ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•æ™‚
      SECRET: devsecret
      API_DOMAIN: localhost
      FE_URL: http://app:3000 #ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚
      FE_URL2: http://localhost:3000 #ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•æ™‚
    volumes:
      - ./trello-clone-api:/app

volumes:
  db-data:
    driver: local
```

æ³¨æ„ï¼šå„ã‚µãƒ¼ãƒ“ã‚¹ãŒä»–ã®ãƒãƒ¼ãƒˆç•ªå·ã¨è¢«ã‚‰ãªã„ã‚ˆã†æ³¨æ„ã™ã‚‹

- API ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã™ã‚‹ã€‚

```sh
cd hoge-app
mkdir frontend backend
```

### API ã®ç’°å¢ƒæ§‹ç¯‰æ‰‹é †

- go ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

```sh
cd backend
# hoge-app-rest-apiã¯ä»»æ„ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
go mod init hoge-app-rest-api
```

- Dockerfile ã®æº–å‚™

```Dockerfile
FROM golang:1.21-alpine

WORKDIR /app
#COPY . /app
COPY go.mod /app
COPY startup.sh /app
COPY air.toml /app

RUN go mod download
RUN apk add --no-cache bash
# delvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒ‡ãƒãƒƒã‚°ï¼‰
RUN go install github.com/go-delve/delve/cmd/dlv@latest
#RUN go install github.com/go-delve/delve/cmd/dlv@v1.21.2
# airã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
RUN go install github.com/cosmtrek/air@latest
#RUN go install github.com/cosmtrek/air@v1.49.0

ENV PATH="/go/bin:${PATH}"

RUN chmod +x ./startup.sh

EXPOSE 8080

CMD ["/bin/bash", "./startup.sh"]
```

- startup.sh ã®ä½œæˆ

```sh
#!/bin/bash

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
go run migrate/migrate.go

# ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã§ã®å®Ÿè¡Œ
# air

# ãƒ‡ãƒãƒƒã‚°ã§ã®å®Ÿè¡Œ
dlv debug ./main.go --headless --listen=:2345 --log --api-version=2
```

ãƒ‡ãƒãƒƒã‚°ã‹ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã§ã®å®Ÿè¡Œã«åˆã‚ã›ã¦ä¸Šè¨˜ã‚’å¤‰æ›´ã™ã‚‹ã€‚
â€»ã“ã“ã¯èª²é¡Œï¼šãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã‹ã¤ãƒ‡ãƒãƒƒã‚°ãŒã§ãã‚Œã°æœ€é©

- .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„
  ç’°å¢ƒå¤‰æ•°ã‚’æ ¼ç´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„

â€»ã“ã“ã¯ Docker ä½¿ã†ãªã‚‰ç’°å¢ƒå¤‰æ•°ã¯ docker-compose.yml ã§ã‚‚ã„ã„ã‹ã‚‚

```sh
touch .env
```

```env
PORT=8080
POSTGRES_USER=user
POSTGRES_PW=password
POSTGRES_DB=mydb
POSTGRES_PORT=5434
POSTGRES_HOST=localhost
SECRET={JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã™ã‚‹éš›ã«ä½¿ç”¨ã™ã‚‹ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼}
GO_ENV=dev
API_DOMAIN=localhost
FE_URL=http://localhost:3000
```

å„ç’°å¢ƒå¤‰æ•°ã‚’å®šç¾©ã—ã¦ã„ãã€‚

- ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒª air ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

```sh
touch air.toml
```

```toml
# .air.toml
root = "."
tmp_dir = "tmp"

[build]
cmd = "go build -o ./tmp/main ."
delay = 1000 # ms
stop_signal = "SIGTERM"
exclude_dir = ["assets", "tmp", "vendor"]
include_ext = ["go", "tpl", "tmpl", "html"]
exclude_file = []
exclude_regex = []
exclude_unchanged = false
follow_symlink = false
full_bin = "/app/tmp/main"

[log]
time = true
level = "debug"

[misc]
clean_on_exit = true
```

- CleanArchitecture ã§å®Ÿè£…ã—ã¦ã„ããŸã‚ã®å„å±¤ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ãŠã‚ˆã³å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç”¨æ„

```sh
mkdir db migrate router controller usecase repository model validator
```

CleanArchitecture ã®å„å±¤ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å‘½åã¯ã”è‡ªç”±ã«

- ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’ç”¨æ„

```sh
touch main.go
```

```go
package main

import (
	// å„ç’°å¢ƒã«åˆã‚ã›ã¦å„å±¤ã‚’import
)

func main() {
	connectDB := db.NewDB()

	// user
	userValidation := validator.NewUserValidator()
	userRepository := repository.NewUserRepository(connectDB)
	userUsecase := usecase.NewUserUsecase(userRepository, userValidation)
	userController := controller.NewUserController(userUsecase)

	// router
	e := router.NewRouter(userController)
	e.Logger.Fatal(e.Start(":8080"))
}
```

- users ãƒ†ãƒ¼ãƒ–ãƒ«ã«é–¢ã™ã‚‹ model ã‚’ç”¨æ„

```sh
touch model/user.go
```

```go
package model

import "time"

type User struct {
	// GORMã®æ©Ÿèƒ½ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã«è‡ªå‹•ã§è¤‡æ•°å½¢ã«ã—ã¦ãã‚Œã‚‹ã€‚
	// â†’usersãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
	ID        uint      `json:"id" gorm:"primaryKey"` //intã®primaryKeyã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§AuotIncrementã‚‚è¨­å®šã•ã‚Œã‚‹ã€‚ï¼ˆGORMï¼‰
	Email     string    `json:"email" gorm:"unique; not null;"`
	Password  string    `json:"password" gorm:"not null"`
	CreatedAt time.Time `json:"created_at"`
	UpdatedAt time.Time `json:"updated_at"`
}

type UserResponse struct {
	ID    uint   `json:"id"`
	Email string `json:"email"`
}
```

- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã«é–¢ã™ã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨ã‚µãƒ³ãƒ—ãƒ«ã®ã¿ç”¨æ„ï¼‰

```sh
touch router/router.go
```

```go
package router

import (
	// å„ç’°å¢ƒã«åˆã‚ã›ã¦controllerã‚’import
	"net/http"
	"os"

	echojwt "github.com/labstack/echo-jwt/v4"
	"github.com/labstack/echo/v4"
	"github.com/labstack/echo/v4/middleware"
)

func NewRouter(uc controller.IUserController, fc controller.IFavoriteController) *echo.Echo {
	e := echo.New()

	e.Use(middleware.CORSWithConfig(middleware.CORSConfig{
		// DefaultCORSConfig = CORSConfig{
		// 	Skipper:      DefaultSkipper,
		// 	AllowOrigins: []string{"*"},
		// 	AllowMethods: []string{http.MethodGet, http.MethodHead, http.MethodPut, http.MethodPatch, http.MethodPost, http.MethodDelete},
		// }
		AllowOrigins: []string{"http://localhost:3000", os.Getenv("FE_URL")},
		AllowHeaders: []string{echo.HeaderOrigin, echo.HeaderContentType, echo.HeaderAccept,
			echo.HeaderAccessControlAllowOrigin, echo.HeaderXCSRFToken},
		AllowCredentials: true,
	}))

	e.Use(middleware.CSRFWithConfig(middleware.CSRFConfig{
		// DefaultCSRFConfig = CSRFConfig{
		// 	Skipper:      DefaultSkipper,
		// 	TokenLength:  32,
		// 	TokenLookup:  "header:" + echo.HeaderXCSRFToken,
		// 	ContextKey:   "csrf",
		// 	CookieName:   "_csrf",
		// 	CookieMaxAge: 86400,
		// }
		CookiePath:     "/",
		CookieDomain:   os.Getenv("API_DOMAIN"),
		CookieSecure:   true,
		CookieHTTPOnly: true,
		CookieSameSite: http.SameSiteNoneMode,
		// CookieSameSite: http.SameSiteDefaultMode, //PostManç¢ºèªç”¨ã€‚ï¼ˆSameSiteNoneModeã ã¨SecureãŒè‡ªå‹•ã§trueã«ãªã‚‹ãŸã‚ï¼‰
	}))

	e.POST("/signup", uc.SignUp)
	e.POST("/login", uc.Login)
	e.POST("/logout", uc.Logout)
	e.GET("/csrf", uc.GetCsrf)

	// â†“â†“ä»¥é™ã¯å‚è€ƒä¾‹â†“â†“
	h := e.Group("/hoge")
	h.Use(echojwt.WithConfig(echojwt.Config{
		// **************************
		// /hoge/*ã«å¯¾ã—ã¦jwtã‚’ä½¿ç”¨ã™ã‚‹ä¾‹
		// **************************
		// Optional. Default value "header:Authorization".
		TokenLookup: "cookie:token",
		SigningKey:  []byte(os.Getenv("SECRET")),
	}))
	h.GET("", fc.GetHoge)
	// â†‘â†‘ä»¥é™ã¯å‚è€ƒä¾‹â†‘â†‘

	e.Use(middleware.Logger())
	return e
}
```

- controller

ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã«é–¢ã™ã‚‹ controller ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

```sh
touch controller/user_controller.go
```

```go
package controller

import (
	//å„ç’°å¢ƒã«åˆã‚ã›ã¦modelã¨usecaseã‚’import
	"net/http"
	"os"
	"time"

	"github.com/labstack/echo/v4"
)

// interface
type IUserController interface {
	SignUp(c echo.Context) error
	Login(c echo.Context) error
	Logout(c echo.Context) error
	GetCsrf(c echo.Context) error
}

// interfaceã‚’å®Ÿè£…ã™ã‚‹struct
type userController struct {
	uu usecase.IUserUsecase
}

// ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
func NewUserController(uu usecase.IUserUsecase) IUserController {
	return &userController{uu: uu}
}

// ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©
func (uc *userController) SignUp(c echo.Context) error {
	user := model.User{}
	if err := c.Bind(&user); err != nil {
		return c.JSON(http.StatusBadRequest, err.Error())
	}
	resUser, err := uc.uu.SignUp(user)
	if err != nil {
		return c.JSON(http.StatusInternalServerError, err.Error())
	}
	return c.JSON(http.StatusCreated, resUser)
}

func (uc *userController) Login(c echo.Context) error {
	user := model.User{}
	if err := c.Bind(&user); err != nil {
		return c.JSON(http.StatusBadRequest, err.Error())
	}
	token, err := uc.uu.Login(user)
	if err != nil {
		return c.JSON(http.StatusBadRequest, err.Error())
	}
	cookie := http.Cookie{
		Name:     "token",
		Value:    token,
		Path:     "/",
		Domain:   os.Getenv("API_DOMAIN"),
		Expires:  time.Now().Add(24 * time.Hour),
		Secure:   true, //Postmanã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã¨ãã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
		HttpOnly: true,
		SameSite: http.SameSiteNoneMode, // ãƒ•ãƒ­ãƒ³ãƒˆSPAã®ãŸã‚ã€None
	}
	c.SetCookie(&cookie)
	return c.NoContent(http.StatusOK)
}

func (uc *userController) Logout(c echo.Context) error {
	cookie := http.Cookie{
		Name:    "token",
		Value:   "",
		Path:    "/",
		Domain:  os.Getenv("API_DOMAIN"),
		Expires: time.Now(),
		// Secure:   true, //Postmanã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã¨ãã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
		HttpOnly: true,
		SameSite: http.SameSiteNoneMode, // ãƒ•ãƒ­ãƒ³ãƒˆSPAã®ãŸã‚ã€None
	}
	c.SetCookie(&cookie)
	return c.NoContent(http.StatusOK)
}

func (uc *userController) GetCsrf(c echo.Context) error {
	token := c.Get("csrf").(string)
	return c.JSON(http.StatusOK, echo.Map{
		"csrf_token": token,
	})
}
```

- usecase

ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã«é–¢ã™ã‚‹ usecase ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

```sh
touch usecase/user_usecase.go
```

```go
package usecase

import (
	// å„ç’°å¢ƒã«åˆã‚ã›ã¦modelã€repositoryã€validatorã‚’importã™ã‚‹

	"os"
	"time"
	"trello-colen-api/model"

	"github.com/golang-jwt/jwt/v5"
	"golang.org/x/crypto/bcrypt"
)

// ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
type IUserUsecase interface {
	SignUp(user model.User) (model.UserResponse, error)
	Login(user model.User) (string, error)
}

// ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã™ã‚‹struct
type userUsecase struct {
	ur repository.IUserRepository
	uv validator.IUserValidator
}

// ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
func NewUserUsecase(ur repository.IUserRepository, uv validator.IUserValidator) IUserUsecase {
	return &userUsecase{ur: ur, uv: uv}
}

//å‡¦ç†éƒ¨

// SignUpï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
func (uu *userUsecase) SignUp(user model.User) (model.UserResponse, error) {
	if err := uu.uv.UserValidate(user); err != nil {
		return model.UserResponse{}, err
	}
	hashPass, err := bcrypt.GenerateFromPassword([]byte(user.Password), 10)
	if err != nil {
		return model.UserResponse{}, err
	}
	newUser := model.User{
		Email:    user.Email,
		Password: string(hashPass),
	}
	if err := uu.ur.CreateUser(&newUser); err != nil {
		return model.UserResponse{}, err
	}
	userRes := model.UserResponse{
		ID:    newUser.ID,
		Email: newUser.Email,
	}
	return userRes, nil
}

func (uu *userUsecase) Login(user model.User) (string, error) {
	storedUser := model.User{}
	if err := uu.ur.GetUserByEmail(&storedUser, user.Email); err != nil {
		return "", err
	}
	if err := bcrypt.CompareHashAndPassword([]byte(storedUser.Password), []byte(user.Password)); err != nil {
		return "", err
	}
	token := jwt.NewWithClaims(jwt.SigningMethodHS256, &jwt.MapClaims{
		"user_id": storedUser.ID,
		"exp":     time.Now().Add(time.Hour * 12).Unix(),
	})
	tokenString, err := token.SignedString([]byte(os.Getenv("SECRET")))
	if err != nil {
		return "", err
	}
	return tokenString, nil
}
```

- repository

ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã«é–¢ã™ã‚‹ repostory ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

```sh
touch repository/user_repository.go
```

```go
package repository

import (
	// å„ç’°å¢ƒã«åˆã‚ã›ã¦modelã‚’importã™ã‚‹

	"gorm.io/gorm"
)

// ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
type IUserRepository interface {
	GetUserByEmail(user *model.User, email string) error
	CreateUser(user *model.User) error
}

// ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã™ã‚‹æ§‹é€ ä½“
type userRepository struct {
	db *gorm.DB
}

// ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
func NewUserRepository(db *gorm.DB) IUserRepository {
	return &userRepository{db: db}
}

// å®Ÿè£…éƒ¨
func (ur *userRepository) GetUserByEmail(user *model.User, email string) error {
	if err := ur.db.Where("email = ?", email).First(user).Error; err != nil {
		return err
	}
	return nil
}

func (ur *userRepository) CreateUser(user *model.User) error {
	if err := ur.db.Create(user).Error; err != nil {
		return err
	}
	return nil
}
```

- validator

ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã«é–¢ã™ã‚‹ validator ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

```sh
touch validator/user_validator.go
```

```go
package validator

import (
	// å„ç’°å¢ƒã«åˆã‚ã›ã¦modelã‚’importã™ã‚‹

	validation "github.com/go-ozzo/ozzo-validation/v4"
	"github.com/go-ozzo/ozzo-validation/v4/is"
)

type IUserValidator interface {
	UserValidate(user model.User) error
}

type userValidator struct{}

func NewUserValidator() IUserValidator {
	return &userValidator{}
}

func (uv *userValidator) UserValidate(user model.User) error {
	return validation.ValidateStruct(&user,
		validation.Field(
			&user.Email,
			validation.Required.Error("email is required"),
			validation.RuneLength(1, 30).Error("limited max 30 char"),
			is.Email.Error("is not valid email format"),
		),
		validation.Field(
			&user.Password,
			validation.Required.Error("password is required"),
			validation.RuneLength(6, 30).Error("limited min 6 max 30 char"),
		),
	)
}
```

- db/db.go ã‚’ä½œæˆã—ã€ç·¨é›†

```sh
touch db/db.go
```

db.go ã« db æ¥ç¶šã¨ã‚¯ãƒ­ãƒ¼ã‚ºã™ã‚‹ãŸã‚ã®é–¢æ•°ã‚’ä½œæˆ

```go
package db

import (
	"fmt"
	"log"
	"os"

	// "github.com/joho/godotenv"
	"gorm.io/driver/postgres"
	"gorm.io/gorm"
)

func NewDB() *gorm.DB {
	// Dockerã®ç’°å¢ƒå¤‰æ•°ã§è¨­å®šã—ã¦ã„ã‚‹ãŸã‚ä»¥ä¸‹ã¯ä¸è¦ã«ãªã‚Šãã†
	// if os.Getenv("GO_ENV") == "dev" {
	// 	err := godotenv.Load()
	// 	if err != nil {
	// 		log.Fatalln(err)
	// 	}
	// }
	url := fmt.Sprintf("postgres://%s:%s@%s:%s/%s", os.Getenv("POSTGRES_USER"),
		os.Getenv("POSTGRES_PW"), os.Getenv("POSTGRES_HOST"), os.Getenv("POSTGRES_PORT"), os.Getenv("POSTGRES_DB"))
	db, err := gorm.Open(postgres.Open(url), &gorm.Config{})
	if err != nil {
		log.Fatalln(err)
	}
	fmt.Println("db connected!")
	return db
}

func CloseDB(db *gorm.DB) {
	sqlDB, _ := db.DB()
	if err := sqlDB.Close(); err != nil {
		log.Fatalln(err)
	}
}
```

go mod tidy ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€gormã€godotenvã€postgresql ã®ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®ä¾å­˜é–¢ä¿‚ã‚’è§£æ±ºã—ã¦ãŠãã€‚

- migrate/migrate.go ã‚’ä½œæˆã—ã€ç·¨é›†

```sh
touch migrate/migrate.go
```

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®é–¢æ•°ä½œæˆ

```go
package main

import (
	"fmt"
	// å„ç’°å¢ƒã«åˆã‚ã›ã¦ã€dbã¨modelã‚’import
)

func main() {
	dbConn := db.NewDB()
	defer fmt.Println("Successfully Migrated")
	defer db.CloseDB(dbConn)
	// ä¾‹ï¼šuserã¨taskãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ãŸã„å ´åˆ
	dbConn.AutoMigrate(&model.User{}) //ä½œæˆã—ãŸã„ãƒ¢ãƒ‡ãƒ«ã®structã‚’0å€¤ã§å¼•æ•°ã«æ¸¡ã™
}
```

- ã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒã§ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã€‚

```sh
touch .vscode/launch.json
```

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Docker: Attach to Go",
      "type": "go",
      "request": "attach",
      "mode": "remote",
      "remotePath": "/app",
      // "program": "${workspaceFolder}/main.go",
      "port": 2345,
      "host": "127.0.0.1",
      "showLog": true,
      "debugAdapter": "legacy" //2024/04æ™‚ç‚¹ï¼šç‰¹å®šã®vscodeã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã ã¨ã“ã®è¨­å®šã«ã—ã¦ãŠã‹ãªã„ã¨ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹ã€‚https://github.com/golang/vscode-go/issues/3175
    }
  ]
}
```

docker-compose ã§ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•å¾Œã€ãƒ‡ãƒãƒƒã‚°ï¼ˆDocker: Attach to Goï¼‰ã‚’èµ·å‹•ã™ã‚‹ã¨ã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‡ãƒãƒƒã‚°ã§ãã‚‹ã€‚
æ³¨æ„ç‚¹ã¨ã—ã¦ã¯ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œã—ãŸå ´åˆã¯ã€ãƒ‡ãƒãƒƒã‚¬ãƒ¼ã‚’èµ·å‹•ã—ãªã„ã¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ è‡ªä½“ãŒèµ·å‹•ã—ãªã„ç‚¹

- ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰
  startup.sh å†…ã® air ã§ã®èµ·å‹•ã‚³ãƒãƒ³ãƒ‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã—ã€ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã™ã‚‹ã€‚

```sh
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
go run migrate/migrate.go

# ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
air
# ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œ
# dlv debug ./main.go --headless --listen=:2345 --log --api-version=2
```

- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä»¥ä¸‹ã‚’ä½œæˆ
  - openapi.yml

```sh
mkdir doc
touch doc/openapi.yml
```

ã‚µãƒ³ãƒ—ãƒ«

```yml
openapi: "3.0.3"

info:
  title: "TodoApp API"
  version: "1.0.0"

paths:
  "/signup":
    post:
      summary: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²"
      description: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²"
      deprecated: false #trueã®å ´åˆã€å»ƒæ­¢
      tags: ["authentication"]
      parameters: []
      requestBody:
        description: "emailã€passwordã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«å«ã‚ã‚‹"
        required: true # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ãŒå¿…è¦ã‹å¦ã‹
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string, example: "testuser@test.com" }
                password: { type: string, example: "testpass" }
      responses:
        "201":
          description: "æˆåŠŸ"
        "400":
          description: "é€ä¿¡ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£"
          content:
            application/json:
              schema:
                type: object
                properties:
                  code: { type: string, example: 400 }
                  message: { type: string, example: "bad request" }
        "500":
          description: "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼"
          content:
            application/json:
              schema:
                type: object
                properties:
                  code: { type: string, example: 500 }
                  message: { type: string, example: "server error" }
  "/login":
    post:
      summary: "ãƒ­ã‚°ã‚¤ãƒ³"
      description: "ãƒ­ã‚°ã‚¤ãƒ³ï¼šæˆåŠŸæ™‚tokenç™ºè¡Œ"
      tags: ["authentication"]
      deprecated: false #trueã®å ´åˆã€å»ƒæ­¢
      requestBody:
        description: "emailã€passwordã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«å«ã‚ã‚‹"
        required: true # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ãŒå¿…è¦ã‹å¦ã‹
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string, example: "testuser@test.com" }
                password: { type: string, example: "testpass" }
      responses:
        "200":
          description: "æˆåŠŸ"
        "400":
          description: "é€ä¿¡ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£"
          content:
            application/json:
              schema:
                type: object
                properties:
                  code: { type: string, example: 400 }
                  message: { type: string, example: "bad request" }
        "500":
          description: "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼"
          content:
            application/json:
              schema:
                type: object
                properties:
                  code: { type: string, example: 500 }
                  message: { type: string, example: "server error" }
      security:
        - tokenKey: []

  "/logout":
    post:
      summary: "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ"
      description: "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼šæˆåŠŸæ™‚tokenå¤±åŠ¹"
      tags: ["authentication"]
      deprecated: false #trueã®å ´åˆã€å»ƒæ­¢
      requestBody:
        description: "ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ãªã—"
        required: false # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ãŒå¿…è¦ã‹å¦ã‹
        content: {}
      responses:
        "200":
          description: "æˆåŠŸ"
        "500":
          description: "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼"
          content:
            application/json:
              schema:
                type: object
                properties:
                  code: { type: string, example: 500 }
                  message: { type: string, example: "server error" }
# security:
#   - tokenKey: []

components:
  securitySchemes:
    tokenKey:
      description: "JWT authentication"
      type: http
      scheme: bearer
      bearerFormat: JWT
```

### frontend ã®ç’°å¢ƒæ§‹ç¯‰æ‰‹é †

- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

```sh
npx create-react-app {ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå}

# typescriptã‚’ä½¿ã†å ´åˆ
npx create-react-app {ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå} --template typescript
```

- Dockerfile ã®ä½œæˆ

```sh
cd {ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå}
touch Dockerfile
```

```Dockerfile
# Node.jsã®å…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ™ãƒ¼ã‚¹ã«ä½¿ç”¨
FROM node:20.11

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
WORKDIR /app

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¾å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY package*.json ./
RUN npm install

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ†ãƒŠå†…ã«ã‚³ãƒ”ãƒ¼
# COPY . .

# ã‚¢ãƒ—ãƒªãŒãƒªãƒƒã‚¹ãƒ³ã™ã‚‹ãƒãƒ¼ãƒˆã‚’æŒ‡å®š
EXPOSE 3000

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
CMD ["npm", "start"]
```

- .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„

```sh
touch .env
```

```env
REACT_APP_API_URL=http://localhost:8080
```

æ³¨æ„ï¼šã“ã“ã§æ³¨æ„ãŒå¿…è¦ãªã®ã¯ã€React ã‚¢ãƒ—ãƒªã¨ api ã®é€šä¿¡ã¯ã‚³ãƒ³ãƒ†ãƒŠåŒå£«ã®é€šä¿¡ã§ã¯ãªãã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã®é€šä¿¡ã¨ãªã‚‹ãŸã‚ã€ãƒ›ã‚¹ãƒˆåã¯`api`ã§ã¯ãªãã€`localhost`ã¨ãªã‚‹ã€‚

- tailwindcss ã®å°å…¥

```sh
npm install -D tailwindcss postcss autoprefixer
npx tailwindcss init
```

- tailwind.config.js ã‚’æ›¸ãæ›ãˆã‚‹

```js
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: ["./src/**/*.{js,jsx,tx,tsx}"],
  theme: {
    extend: {},
  },
  plugins: [],
};
```

- index.css ã«è¨­å®š

```css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
  react-router-dom ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```sh
# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
npm info react-router-dom versions

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä»»æ„ã§ã©ã†ãï¼‰
npm install react-router-dom@6.22.0
```

- axios
  axios ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```sh
npm info axios versions
npm install axios@1.6.7
```

- react-icons ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```sh
npm install react-icons --save
```

- App.js

```js
import { BrowserRouter as Router, Routes, Route } from "react-router-dom";
import Auth from "./components/Auth/Auth";
import { useEffect } from "react";
import axios from "axios";

const App = () => {
  useEffect(() => {
    const getCsrf = async () => {
      axios.defaults.withCredentials = true;
      const { data } = await axios.get(
        `${process.env.REACT_APP_API_URL}/csrf`
        // {withCredentials: true}
      );
      axios.defaults.headers.common["X-CSRF-Token"] = data.csrf_token;
    };
    getCsrf();
  });
  return (
    <Router>
      <Routes>
        <Route path="/" element={<Auth />} />
        {/* ä»¥ä¸‹ã®å‚è€ƒä¾‹ã‚’ã‚‚ã¨ã«å®Ÿéš›ã®æ©Ÿèƒ½ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¡Œã† */}
        {/* <Route path="/todo" element={<TodoApp/>} /> */}
      </Routes>
    </Router>
  );
};

export default App;
```

- components/Auth/Auth.js

èªè¨¼ç”»é¢ã®ä½œæˆ

```js
import { FaUserPlus } from "react-icons/fa";
import { FaArrowRightFromBracket } from "react-icons/fa6";
import { useState } from "react";
import { useNavigate } from "react-router-dom";

import auth from "../../util/auth";
import useError from "../../hooks/useError";

const Auth = () => {
  const [isLoginDisp, setIsLoginDist] = useState(true);
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const navigate = useNavigate();
  const { signup, login } = auth();
  const { switchErrorHandling } = useError();

  const sendUserForm = (e) => {
    e.preventDefault();
    if (isLoginDisp) {
      // ãƒ­ã‚°ã‚¤ãƒ³
      const doLogin = async () => {
        try {
          await login(email, password);

          //************************
          // ãƒ­ã‚°ã‚¤ãƒ³ãŒæˆåŠŸã—ãŸã®ã¡ã«ã©ã®ãƒ‘ã‚¹ã«é£›ã°ã™ã‹ä»¥ä¸‹ã§æŒ‡å®š
          //************************
          navigate("/todo");
        } catch (err) {
          if (err.response.data.message) {
            // csrf,jwtãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ç³»ã®ã‚¨ãƒ©ãƒ¼ã¯messageã«å…¥ã‚‹
            switchErrorHandling(err.response.data.message);
          } else {
            switchErrorHandling(err.response.data);
          }
        }
      };
      doLogin();
    } else {
      // ç™»éŒ²
      const doSignup = async () => {
        try {
          await signup(email, password);
          await login(email, password);
          navigate("/search");
        } catch (err) {
          if (err.response.data.message) {
            // csrf,jwtãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ç³»ã®ã‚¨ãƒ©ãƒ¼ã¯messageã«å…¥ã‚‹
            switchErrorHandling(err.response.data.message);
          } else {
            switchErrorHandling(err.response.data);
          }
        }
      };
      doSignup();
    }
  };
  return (
    <div className="flex justify-center mt-10">
      <div className="w-full max-w-xs">
        <form
          className="bg-slate-200 shadow-md rounded px-8 pt-6 pb-8 mb-4"
          onSubmit={sendUserForm}
        >
          <h4 className="text-center text-2xl">
            {isLoginDisp ? (
              <span>ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢</span>
            ) : (
              <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</span>
            )}
          </h4>
          <div className="mb-4">
            <label
              className="block text-gray-700 text-sm font-bold mb-2"
              htmlFor="email"
            >
              E-Mail
            </label>
            <input
              className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              id="email"
              type="text"
              placeholder="xxx@test.com"
              value={email}
              onChange={(e) => {
                setEmail(e.target.value);
              }}
            />
          </div>
          <div className="mb-6">
            <label
              className="block text-gray-700 text-sm font-bold mb-2"
              htmlFor="password"
            >
              Password
            </label>
            {/* <input className="shadow appearance-none border border-red-500 rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
						id="password" type="password" placeholder="******************" onChange={(e) => {setPassword(e.target.value)}} />
						<p className="text-red-500 text-xs italic">Please choose a password.</p> */}
            <input
              className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
              id="password"
              type="password"
              placeholder="******************"
              value={password}
              onChange={(e) => {
                setPassword(e.target.value);
              }}
            />
          </div>
          <div className="flex justify-center items-center">
            <button
              className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
              type="submit"
            >
              {isLoginDisp ? "Login" : "SignUp"}
            </button>
          </div>
          <div className="flex justify-center mt-5">
            {isLoginDisp ? (
              <FaUserPlus
                onClick={() => {
                  setIsLoginDist((prev) => !prev);
                }}
                className="cursor-pointer"
              />
            ) : (
              <FaArrowRightFromBracket
                onClick={() => {
                  setIsLoginDist((prev) => !prev);
                }}
                className="cursor-pointer"
              />
            )}
          </div>
        </form>
      </div>
    </div>
  );
};

export default Auth;
```

- util/auth.js

èªè¨¼ç”¨ã®é–¢æ•°

```js
import axios from "axios";

const auth = () => {
  const signup = async (email, password) => {
    const res = await axios.post(`${process.env.REACT_APP_API_URL}/signup`, {
      email: email,
      password: password,
    });
    return res;
  };
  const login = async (email, password) => {
    const res = await axios.post(
      `${process.env.REACT_APP_API_URL}/login`,
      {
        email: email,
        password: password,
      }
      // {withCredentials: true,}
    );
    return res;
  };
  const logout = async () => {
    const res = await axios.post(
      `${process.env.REACT_APP_API_URL}/logout`
      // {withCredentials: true}
    );
    return res;
  };
  return { signup, login, logout };
};

export default auth;
```

- hooks/useError.js

ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç”¨ã® hooks

```js
import axios from "axios";
import { useNavigate } from "react-router-dom";

const useError = () => {
  const navigate = useNavigate();
  const getCsrfToken = async () => {
    const { data } = await axios.get(`${process.env.REACT_APP_API_URL}/csrf`);
    axios.defaults.headers.common["X-CSRF-Token"] = data.csrf_token;
  };

  const switchErrorHandling = (msg) => {
    switch (msg) {
      case "invalid csrf token":
        getCsrfToken();
        alert("CSRF token is invalid, please try again");
        break;
      case "invalid or expired jwt":
        alert("access token expired, please login");
        navigate("/");
        break;
      case "missing or malformed jwt":
        alert("access token is not valid, please login");
        navigate("/");
        break;
      case "duplicated key not allowed":
        alert("email already exist, please use another one");
        break;
      case "crypto/bcrypt: hashedPassword is not the hash of the given password":
        alert("password is not correct");
        break;
      case "record not found":
        alert("email is not correct");
        break;
      default:
        alert(msg);
    }
  };
  return { switchErrorHandling };
};
export default useError;
```

## çµ‚ã‚ã‚Š

ä¸€æ—¦ã“ã‚Œã§é››å½¢ãŒã§ãã‚‹ã‹ã¨ï¼
